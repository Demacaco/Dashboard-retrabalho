<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Retrabalhos - Análise do Período</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Midnight Slate -->
    <!-- Application Structure Plan: This version introduces a critical evolution: dynamic data loading. The SPA no longer holds static data. It now fetches live data from the Google Sheet via a dedicated Apps Script function upon loading. This transforms the dashboard from a static report into a live, auto-updating BI tool. The information architecture and UI remain the same, but the data layer is now dynamic. -->
    <!-- Visualization & Content Choices: 
        - Data Source: Changed from a hardcoded JS array to a live `fetch` call to a Google Sheet Web App. Goal: Create a live, dynamic dashboard.
        - Loading State: A simple loading indicator is added to inform the user that data is being fetched. Goal: Improve UX during data load.
        - All other visualizations and interactions are preserved but now operate on the live data fetched from the spreadsheet, making the entire application dynamic.
        - CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 50vh;
        }
        .filter-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
            padding: 1rem;
            text-align: center;
        }
    </style>
</head>
<body class="text-gray-300">

    <div id="loading-overlay">
        <p>A carregar dados ao vivo da planilha...</p>
    </div>

    <div id="dashboard-content" class="container mx-auto p-4 md:p-8 max-w-7xl hidden">
        
        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Dashboard de Retrabalhos</h1>
            <p id="dashboard-subtitle" class="text-lg text-gray-400 mt-2">Análise do Período Completo</p>
        </header>

        <main>
            <section id="filters" class="mb-8 bg-gray-800 rounded-xl p-6 shadow-lg">
                <h2 class="text-lg font-semibold text-white mb-3 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M3 6h18M7 12h10M10 18h4"/></svg>
                    Filtrar por Período
                </h2>
                <div id="date-filters-container" class="flex flex-wrap gap-2">
                    <button class="filter-btn bg-gray-700 text-gray-200 px-4 py-2 rounded-lg text-sm hover:bg-gray-600 active" data-date="all">Ver Tudo</button>
                </div>
            </section>

            <section id="kpis" class="mb-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-gray-800 rounded-xl p-6 text-center shadow-lg transition hover:transform hover:-translate-y-1">
                        <h3 class="text-lg font-semibold text-gray-400">Quantidade Total de Itens</h3>
                        <p id="total-items" class="text-4xl font-bold text-blue-400 mt-2">0</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-6 text-center shadow-lg transition hover:transform hover:-translate-y-1">
                        <h3 class="text-lg font-semibold text-gray-400">Total de Registos</h3>
                        <p id="total-entries" class="text-4xl font-bold text-blue-400 mt-2">0</p>
                    </div>
                    <div class="bg-gray-800 rounded-xl p-6 text-center shadow-lg transition hover:transform hover:-translate-y-1">
                        <h3 class="text-lg font-semibold text-gray-400">SKUs Únicos</h3>
                        <p id="unique-skus" class="text-4xl font-bold text-blue-400 mt-2">0</p>
                    </div>
                </div>
            </section>
            
            <section class="bg-gray-800 rounded-xl p-6 shadow-lg mb-12">
                <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-green-400"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
                    Tendência de Retrabalhos por Dia
                </h2>
                <p class="text-gray-400 mb-4">Volume total de itens em retrabalho a cada dia, para identificar picos de atividade.</p>
                <div class="chart-container" style="max-height: 350px;">
                    <canvas id="trendChart"></canvas>
                </div>
            </section>
            
            <section class="bg-gray-800 rounded-xl p-6 shadow-lg mb-12">
                <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-yellow-400"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                    Análise de Retrabalhos por Hora do Dia
                </h2>
                <p class="text-gray-400 mb-4">Horários de pico em que os retrabalhos são registados, ajudando a identificar padrões de produtividade.</p>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </section>

            <section id="charts" class="mb-12 grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                         <h2 class="text-xl font-bold text-white flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-purple-400"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                            Top 10 Itens por Quantidade
                        </h2>
                         <button id="sort-sku-chart" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 w-full sm:w-auto">Ordenar</button>
                    </div>
                    <p class="text-gray-400 mb-4">Os itens com maior volume de peças em retrabalho no período selecionado.</p>
                    <div class="chart-container">
                        <canvas id="skuChart"></canvas>
                    </div>
                </div>
                <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center">
                       <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-red-400"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Atividade por Coletor
                    </h2>
                    <p class="text-gray-400 mb-4">Registos feitos por cada operador no período selecionado.</p>
                    <div id="collector-container" class="space-y-4 mt-6">
                    </div>
                </div>
            </section>
            
        </main>
        
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Dashboard atualizado dinamicamente.</p>
        </footer>
    </div>

    <script>
        // ❗️ IMPORTANTE: Substitua a linha abaixo pela URL da sua implantação do App da Web do Google Apps Script
        const SCRIPT_URL = "URL_DO_SEU_APP_DA_WEB_AQUI";

        let rawData = [];
        let skuChartInstance, collectorChartInstance, trendChartInstance, hourlyChartInstance;
        let currentSkuSort = 'quantity';
        let activeDateFilter = 'all';

        // Função principal para buscar dados da planilha
        async function fetchData() {
            if (SCRIPT_URL === "URL_DO_SEU_APP_DA_WEB_AQUI" || !SCRIPT_URL) {
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-400 text-center max-w-md">ERRO: A URL do script não foi configurada.<br><br>Por favor, edite este ficheiro HTML, encontre a variável SCRIPT_URL e substitua o texto de exemplo pela URL da implantação do seu App da Web.</p>`;
                return;
            }

            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) {
                    throw new Error(`Erro na rede: ${response.statusText}`);
                }
                const data = await response.json();
                
                rawData = data.map(item => ({
                    ...item,
                    timestamp: new Date(item.timestamp),
                    date: new Date(item.date).toISOString().split('T')[0] 
                }));

                initializeApp();
            } catch (error) {
                console.error("Falha ao buscar dados:", error);
                document.getElementById('loading-overlay').innerHTML = `<p class="text-red-400">Erro ao carregar dados. Verifique a URL do script e as permissões da planilha (deve ser 'Qualquer pessoa').</p>`;
            }
        }
        
        // Função para inicializar o dashboard após os dados serem carregados
        function initializeApp() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('dashboard-content').classList.remove('hidden');

            setupDateFilters();
            updateDashboard('all');
            renderTrendChart();
            
            document.getElementById('sort-sku-chart').addEventListener('click', () => {
                let dataToSummarize = rawData;
                 if(activeDateFilter !== 'all') {
                    dataToSummarize = rawData.filter(item => item.date === activeDateFilter);
                }
                const skuSummary = dataToSummarize.reduce((acc, item) => {
                    acc[item.sku] = (acc[item.sku] || 0) + item.quantity;
                    return acc;
                }, {});

                currentSkuSort = currentSkuSort === 'quantity' ? 'alphabetical' : 'quantity';
                document.getElementById('sort-sku-chart').textContent = currentSkuSort === 'quantity' ? 'Ordenar por SKU' : 'Ordenar por Qtd.';
                renderSkuChart(skuSummary, currentSkuSort);
            });
            
            document.getElementById('date-filters-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    const date = e.target.dataset.date;
                    updateDashboard(date);
                }
            });
        }

        function setupDateFilters() {
            const dates = [...new Set(rawData.map(item => item.date))].sort();
            const container = document.getElementById('date-filters-container');
            container.innerHTML = '<button class="filter-btn bg-gray-700 text-gray-200 px-4 py-2 rounded-lg text-sm hover:bg-gray-600 active" data-date="all">Ver Tudo</button>';
            dates.forEach(date => {
                const btn = document.createElement('button');
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                btn.textContent = `Dia ${formattedDate}`;
                btn.dataset.date = date;
                btn.className = 'filter-btn bg-gray-700 text-gray-200 px-4 py-2 rounded-lg text-sm hover:bg-gray-600';
                container.appendChild(btn);
            });
        }

        function updateDashboard(filterDate = 'all') {
            activeDateFilter = filterDate;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.date === filterDate);
            });

            let filteredData = rawData;
            const subtitle = document.getElementById('dashboard-subtitle');
            if (filterDate !== 'all') {
                filteredData = rawData.filter(item => item.date === filterDate);
                const formattedDate = new Date(filterDate + 'T00:00:00').toLocaleDateString('pt-BR', { dateStyle: 'long' });
                subtitle.textContent = `Análise do dia ${formattedDate}`;
            } else {
                subtitle.textContent = 'Análise do Período Completo';
            }
            
            const totalItems = filteredData.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('total-items').textContent = totalItems.toLocaleString('pt-BR');
            
            const totalEntries = filteredData.length;
            document.getElementById('total-entries').textContent = totalEntries.toLocaleString('pt-BR');

            const skuSummary = filteredData.reduce((acc, item) => {
                acc[item.sku] = (acc[item.sku] || 0) + item.quantity;
                return acc;
            }, {});
            
            const uniqueSkus = Object.keys(skuSummary).length;
            document.getElementById('unique-skus').textContent = uniqueSkus;

            const collectorSummary = filteredData.reduce((acc, item) => {
                acc[item.collector] = (acc[item.collector] || 0) + 1;
                return acc;
            }, {});

            renderSkuChart(skuSummary, currentSkuSort);
            renderCollectorCards(collectorSummary);
            renderHourlyChart(filteredData);
        }
        
        function renderTrendChart() {
             const trendData = rawData.reduce((acc, item) => {
                acc[item.date] = (acc[item.date] || 0) + item.quantity;
                return acc;
            }, {});

            const sortedDates = Object.keys(trendData).sort();
            const labels = sortedDates.map(date => new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            const data = sortedDates.map(date => trendData[date]);

            const ctx = document.getElementById('trendChart').getContext('2d');
            if (trendChartInstance) trendChartInstance.destroy();
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
            gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade Diária de Itens',
                        data: data,
                        fill: true,
                        backgroundColor: gradient,
                        borderColor: 'rgba(96, 165, 250, 1)',
                        pointBackgroundColor: 'rgba(96, 165, 250, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(96, 165, 250, 1)',
                        tension: 0.3
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#d1d5db' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#d1d5db' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderHourlyChart(data) {
            const hourlyData = data.reduce((acc, item) => {
                const hour = item.timestamp.getHours();
                acc[hour] = (acc[hour] || 0) + 1;
                return acc;
            }, {});

            const labels = Array.from({ length: 24 }, (_, i) => `${String(i).padStart(2, '0')}h`);
            const chartData = labels.map((_, index) => hourlyData[index] || 0);

            const ctx = document.getElementById('hourlyChart').getContext('2d');
            if (hourlyChartInstance) hourlyChartInstance.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(34, 197, 94, 0.8)');
            gradient.addColorStop(1, 'rgba(34, 197, 94, 0.2)');

            hourlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nº de Registos por Hora',
                        data: chartData,
                        backgroundColor: gradient,
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                 options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Nº de Registos', color: '#d1d5db' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#d1d5db' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#d1d5db' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderSkuChart(summary, sort = 'quantity') {
            if (skuChartInstance) skuChartInstance.destroy();

            const sortedData = Object.entries(summary);
            if (sort === 'quantity') {
                sortedData.sort(([, a], [, b]) => b - a);
            } else {
                sortedData.sort(([a], [b]) => a.localeCompare(b));
            }

            const top10Data = sortedData.slice(0, 10);
            const labels = top10Data.map(item => item[0]);
            const data = top10Data.map(item => item[1]);

            const ctx = document.getElementById('skuChart').getContext('2d');
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(168, 85, 247, 0.8)');
            gradient.addColorStop(1, 'rgba(168, 85, 247, 0.2)');

            skuChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Quantidade em Retrabalho',
                        data: data,
                        backgroundColor: gradient,
                        borderColor: 'rgba(168, 85, 247, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    indexAxis: 'y',
                    scales: {
                        y: { 
                            ticks: { 
                                color: '#d1d5db',
                                callback: function(val) { const label = this.getLabelForValue(val); return label.length > 20 ? label.substr(0, 20) + '...' : label; }
                            },
                            grid: { display: false }
                        },
                        x: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Quantidade de Peças', color: '#d1d5db' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#d1d5db' }
                        }
                    },
                    plugins: { legend: { display: false }, tooltip: { callbacks: { title: (items) => items[0].label } } }
                }
            });
        }

        function renderCollectorCards(summary) {
            const container = document.getElementById('collector-container');
            container.innerHTML = '';
            
            const totalEntries = Object.values(summary).reduce((sum, count) => sum + count, 0);
            if (totalEntries === 0) {
                container.innerHTML = `<p class="text-gray-400 text-center">Nenhum registo para este período.</p>`;
                return;
            }

            const sortedCollectors = Object.entries(summary).sort(([, a], [, b]) => b - a);

            sortedCollectors.forEach(([collectorId, count]) => {
                const percentage = totalEntries > 0 ? (count / totalEntries) * 100 : 0;
                const cardHTML = `
                    <div class="flex items-center p-4 bg-gray-900 rounded-lg">
                        <div class="p-3 rounded-full bg-red-500/20 text-red-400 mr-4">
                           <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
                        </div>
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-1">
                                <p class="font-semibold text-white">Coletor ${collectorId}</p>
                                <p class="text-sm font-medium text-gray-300">${count} Registos</p>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-2.5">
                                <div class="bg-red-400 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHTML;
            });
        }

        // Inicia o processo de busca de dados ao carregar a página
        document.addEventListener('DOMContentLoaded', fetchData);
    </script>
</body>
</html>
